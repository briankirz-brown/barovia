<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barovia Hexcrawl — Minimal</title>
  <style>
    /* =====================
       THEME & BASE STYLES
       ===================== */
    :root{
      --ink:        #d2cdc0; /* bone */
      --ink-dim:    #b8b2a2;
      --accent:     #8a2b2b; /* dried blood */
      --accent-dim: #5a1d1d;
      --bg0:        #0b0e13; /* night */
      --bg1:        #131821; /* deep pine */
      --bg2:        #1a222d; /* slate */
      --tile:       #0f1616; /* bark */
      --tile-edge:  #2f3b3b; /* moss */
      --tile-adj:   #28343a; /* reachable */
      --tile-here:  #464f5a; /* current */
      --tile-hover: #314048;
      --shadow:     rgba(0,0,0,.55);
      --panel:      rgba(20, 16, 16, 0.45);
      --panel-brdr: rgba(255, 232, 224, 0.08);
      --glow:       rgba(138, 43, 43, .65);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html, body { margin: 0; background: var(--bg0); color: var(--ink); font-family: Garamond, Georgia, "Times New Roman", serif; }
    body { overflow: hidden; }

    /* Subtle vignette + grain for mood without assets */
    body::before{
      content:""; position: fixed; inset: 0; pointer-events: none;
      background:
        radial-gradient(120vmax 120vmax at 50% 30%, transparent 40%, rgba(0,0,0,.55) 85%),
        radial-gradient(120vmax 120vmax at 50% 120%, rgba(0,0,0,.3), transparent 60%);
      mix-blend-mode: multiply;
    }
    body::after{
      /* CSS-only film grain */
      content:""; position: fixed; inset: 0; pointer-events:none; opacity:.08;
      background:
        repeating-linear-gradient(0deg, #0000 0 2px, #0001 2px 3px),
        repeating-linear-gradient(90deg, #0000 0 2px, #0001 2px 3px);
      filter: contrast(140%);
    }

    /* ===============
       LAYOUT
       =============== */
    #game { position: relative; width: 100vw; height: 100vh; }
    #map { position: absolute; inset: 0; width: 100%; height: 100%; display: block; }

    .panel {
      position: absolute; border: 1px solid var(--panel-brdr); background: var(--panel);
      backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
      box-shadow: 0 10px 30px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.03);
      border-radius: 14px; padding: 12px 14px;
    }

    #hud { top: 16px; left: 16px; min-width: 220px; }
    #hud h1 { margin: 0 0 4px 0; font-size: 18px; font-variant: small-caps; letter-spacing: 1px; color: var(--ink); text-shadow: 0 0 10px rgba(255,255,255,.06); }
    #healthBar { height: 10px; border-radius: 999px; background: linear-gradient(90deg, var(--accent), var(--accent-dim)); box-shadow: 0 0 12px var(--glow); }
    #healthText, #seedText { margin-top: 6px; font-size: 14px; color: var(--ink-dim); letter-spacing: .3px; }

    #controls { top: 16px; right: 16px; text-align: center; }
    #controls button {
      background: rgba(0,0,0,.2);
      border: 1px solid var(--panel-brdr);
      color: var(--ink);
      font-family: inherit;
      font-size: 12px;
      padding: 4px 8px;
      margin: 0 2px;
      border-radius: 6px;
      cursor: pointer;
    }
    #controls button:hover { background: rgba(255,255,255,0.05); }

    #log {
      left: 16px; bottom: 16px; width: min(36ch, 32vw); height: min(28vh, 32vh);
      overflow: auto; font-size: 14px; line-height: 1.35; color: var(--ink);
      scrollbar-width: thin; scrollbar-color: var(--accent-dim) transparent;
    }
    #log h2 { margin: 0 0 6px 0; font-size: 14px; font-variant: small-caps; letter-spacing:.8px; color: var(--ink-dim); display:flex; align-items:center; gap:6px; }
    #log h2 button { background: none; border: none; color: var(--ink-dim); font-family: inherit; font-size: 12px; cursor: pointer; }
    #log h2 button:hover { color: var(--ink); }
    #copyMsg { font-size: 12px; color: var(--ink-dim); }
    #logList { list-style: none; margin: 0; padding: 0; }
    #logList li { padding: 6px 8px; margin: 0 0 6px 0; background: rgba(0,0,0,.22); border-radius: 8px; border: 1px solid rgba(255,255,255,.03); }

    /* ===============
       HEX STYLES
       =============== */
    .hex { fill: var(--tile); stroke: var(--tile-edge); stroke-width: 1.3; transition: fill .15s ease, stroke .15s ease; }
    .hex:hover { fill: var(--tile-hover); }
    .here { fill: var(--tile-here) !important; stroke: #616b78; }
    .adjacent { fill: var(--tile-adj); }

    /* PLAYER TOKEN */
    #player .ring { fill: none; stroke: rgba(255, 232, 224, .85); stroke-width: 2.2; filter: drop-shadow(0 0 6px rgba(255,255,255,.08)); }
    #player .core { fill: var(--accent); filter: drop-shadow(0 0 10px var(--glow)); }
    #player { transition: transform .15s ease-out; }

    /* Tiny helper label for accessibility (off by default) */
    .sr-only { position: absolute; left: -9999px; }

    /* Ensure no scrollbars from panels on small screens */
    @media (max-width: 700px){
      #log{ width: 46vw; }
    }
  </style>
</head>
<body>
  <div id="game" aria-label="Barovia Hexcrawl minimal prototype">
    <svg id="map" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet" aria-hidden="true"></svg>

      <!-- PANEL-HUD:START -->
      <div id="hud" class="panel" aria-live="polite">
        <h1>Adventurer</h1>
        <div id="healthBar" role="meter" aria-valuemin="0" aria-valuemax="10" aria-valuenow="10" aria-label="Health"></div>
        <div id="healthText">Health: <span id="hp">10</span>/10</div>
        <div id="seedText">Seed: <span id="seed"></span></div>
      </div>
      <!-- PANEL-HUD:END -->

      <!-- PANEL-CONTROLS:START -->
      <div id="controls" class="panel">
        <button id="newGameBtn">New Game</button>
        <button id="saveBtn">Save</button>
        <button id="loadBtn">Load</button>
      </div>
      <!-- PANEL-CONTROLS:END -->

      <!-- PANEL-LOG:START -->
      <div id="log" class="panel" aria-live="polite">
        <h2>
          Journal
          <button id="clearLogBtn">Clear</button>
          <button id="copyLogBtn">Copy</button>
          <span id="copyMsg" aria-live="polite"></span>
        </h2>
        <ul id="logList"></ul>
      </div>
      <!-- PANEL-LOG:END -->
  </div>

  <script>
  (()=>{
    // === REGION:STATE:START ===
    /**
     * Minimal, deterministic hexgrid with adjacency-gated movement.
     * Pointy-top axial coords (q, r). Zero dependencies.
     */

    const COLS = 11;            // width in axial q
    const ROWS = 9;             // height in axial r
    const SIZE = 34;            // radius in px
    const SQRT3 = Math.sqrt(3);

      const svg = document.getElementById('map');
      const logList = document.getElementById('logList');
      const hpText = document.getElementById('hp');
      const seedEl = document.getElementById('seed');
      const healthBar = document.getElementById('healthBar');
      const newBtn = document.getElementById('newGameBtn');
      const saveBtn = document.getElementById('saveBtn');
      const loadBtn = document.getElementById('loadBtn');
      const clearLogBtn = document.getElementById('clearLogBtn');
      const copyLogBtn = document.getElementById('copyLogBtn');
      const copyMsg = document.getElementById('copyMsg');

      const SAVE_KEY = 'barovia.save';
      const tiles = new Map();  // key: `q,r` => tile { q, r, x, y, el }

      const params = new URLSearchParams(window.location.search);
      const initialSeed = params.get('seed') || 'barovia';

    // Player state
      const state = {
        hp: 10,
        here: { q: Math.floor(COLS/2), r: Math.floor(ROWS/2) }, // start near center
        turn: 0,
        seed: initialSeed,
      };
    // === REGION:STATE:END ===

    // === REGION:UTILS:START ===
    function axialToPixel(q, r){
      // pointy-top
      const x = SIZE * SQRT3 * (q + r/2);
      const y = SIZE * (3/2) * r;
      return { x, y };
    }

    function hexCorner(cx, cy, i){
      const angle = Math.PI / 180 * (60 * i - 30);
      return [
        Math.round((cx + SIZE * Math.cos(angle)) * 100) / 100,
        Math.round((cy + SIZE * Math.sin(angle)) * 100) / 100
      ];
    }

    function polygonPoints(cx, cy){
      const pts = [];
      for(let i=0;i<6;i++){
        const [x,y] = hexCorner(cx, cy, i);
        pts.push(x+","+y);
      }
      return pts.join(' ');
    }

    function key(q,r){ return `${q},${r}`; }

    function neighbors(q, r){
      return [ [1,0], [1,-1], [0,-1], [-1,0], [-1,1], [0,1] ].map(([dq,dr])=>({q:q+dq, r:r+dr}));
    }

    function isOnBoard(q, r){
      return q>=0 && q<COLS && r>=0 && r<ROWS;
    }

    function isNeighbor(a, b){
      return neighbors(a.q, a.r).some(n => n.q===b.q && n.r===b.r);
    }
    // === REGION:UTILS:END ===

    // === REGION:RENDER:START ===
    function placePlayer(){
      const id = 'player';
      let g = document.getElementById(id);
      const {x, y} = axialToPixel(state.here.q, state.here.r);
      if(!g){
        g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('id', id);
        // soft ritual ring + ember core
        const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
        ring.setAttribute('class','ring');
        ring.setAttribute('r', String(SIZE * 0.45));
        ring.setAttribute('cx','0'); ring.setAttribute('cy','0');
        const core = document.createElementNS('http://www.w3.org/2000/svg','circle');
        core.setAttribute('class','core');
        core.setAttribute('r', String(SIZE * 0.18));
        core.setAttribute('cx','0'); core.setAttribute('cy','0');
        g.appendChild(ring); g.appendChild(core);
        svg.appendChild(g);
      }
      g.setAttribute('transform', `translate(${x},${y})`);
    }

    function updateHUD(){
      hpText.textContent = String(state.hp);
      healthBar.style.width = (state.hp*10) + '%';
      healthBar.setAttribute('aria-valuenow', String(state.hp));
      seedEl.textContent = state.seed;
    }

    function log(msg){
      const li = document.createElement('li');
      li.textContent = msg;
      logList.appendChild(li);
      // scroll to bottom
      const logPanel = document.getElementById('log');
      logPanel.scrollTop = logPanel.scrollHeight;
    }

    function clearLog(){
      logList.innerHTML = '';
    }

    async function copyLog(){
      const text = Array.from(logList.children).map(li => li.textContent).join('\n');
      try{
        await navigator.clipboard.writeText(text);
        copyMsg.textContent = 'Copied';
      }catch(e){
        copyMsg.textContent = 'Copy failed';
      }
      setTimeout(()=>{ copyMsg.textContent = ''; }, 1000);
    }

    function selectHere(){
      tiles.forEach(t => t.el.classList.remove('here'));
      const t = tiles.get(key(state.here.q, state.here.r));
      if(t) t.el.classList.add('here');
    }

    function markAdjacents(){
      tiles.forEach(t => t.el.classList.remove('adjacent'));
      neighbors(state.here.q, state.here.r)
        .filter(n => isOnBoard(n.q, n.r))
        .forEach(n => {
          const t = tiles.get(key(n.q, n.r));
          if(t) t.el.classList.add('adjacent');
        });
    }

    function buildBoard(){
      // compute extents to set viewBox nicely
      const corners = [];
      for(let r=0;r<ROWS;r++){
        for(let q=0;q<COLS;q++){
          const {x, y} = axialToPixel(q, r);
          corners.push([x - SIZE, y - SIZE]);
          corners.push([x + SIZE, y + SIZE]);
        }
      }
      const xs = corners.map(c=>c[0]);
      const ys = corners.map(c=>c[1]);
      const minX = Math.min(...xs) - 16; // margin
      const minY = Math.min(...ys) - 16;
      const maxX = Math.max(...xs) + 16;
      const maxY = Math.max(...ys) + 16;
      svg.setAttribute('viewBox', `${minX} ${minY} ${maxX - minX} ${maxY - minY}`);

      // draw tiles
      for(let r=0;r<ROWS;r++){
        for(let q=0;q<COLS;q++){
          const {x, y} = axialToPixel(q, r);
          const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
          poly.setAttribute('class','hex');
          poly.setAttribute('points', polygonPoints(x, y));
          poly.dataset.q = String(q);
          poly.dataset.r = String(r);
          poly.addEventListener('click', ()=>{
            tryMove({ q, r });
          });
          svg.appendChild(poly);
          tiles.set(key(q,r), { q, r, x, y, el: poly });
        }
      }
    }

    function init(){
      buildBoard();
      placePlayer();
      selectHere();
      markAdjacents();
      updateHUD();
      log('You wake beneath sullen boughs. Barovia watches.');
      log('Click a highlighted hex to move.');
      try{
        if(localStorage.getItem(SAVE_KEY)){
          log('💾 A save is available — click Load to restore.');
        }
      }catch(e){}
    }
    // === REGION:RENDER:END ===

    // === REGION:MOVE:START ===
    function newGame(){
      state.hp = 10;
      state.here = { q: Math.floor(COLS/2), r: Math.floor(ROWS/2) };
      state.turn = 0;
      placePlayer();
      selectHere();
      markAdjacents();
      updateHUD();
      logList.innerHTML = '';
      log('You wake beneath sullen boughs. Barovia watches.');
      log('Click a highlighted hex to move.');
      localStorage.removeItem(SAVE_KEY);
    }

    function tryMove(to){
      if(!isOnBoard(to.q, to.r)) return;
      if(to.q === state.here.q && to.r === state.here.r) return; // same tile
      if(!isNeighbor(state.here, to)){
        log('The thicket bars your way — too far to stride in one breath.');
        return;
      }
      state.here = { q: to.q, r: to.r };
      state.turn++;
      placePlayer();
      selectHere();
      markAdjacents();
      log(`Step ${state.turn}: You move to (${to.q}, ${to.r}). The pines whisper.`);
      saveGame(true);
    }
    // === REGION:MOVE:END ===

    // === REGION:SAVE:START ===
    function saveGame(silentArg){
      const silent = silentArg === true;
      const data = { q: state.here.q, r: state.here.r, hp: state.hp, turn: state.turn, seed: state.seed };
      try{
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        if(!silent) log('🗝️ Game saved.');
      }catch(e){
        log('⚠️ Save failed (storage blocked by browser).');
      }
    }

    function loadGame(){
      let raw;
      try{
        raw = localStorage.getItem(SAVE_KEY);
      }catch(e){
        log('⚠️ Load failed (storage blocked by browser).');
        return;
      }
      if(!raw){
        log('No save found.');
        return;
      }
      let data;
      try{
        data = JSON.parse(raw);
      }catch(e){
        log('⚠️ Save is corrupted.');
        return;
      }
      if(typeof data !== 'object' || typeof data.q !== 'number' || typeof data.r !== 'number' ||
         typeof data.hp !== 'number' || typeof data.turn !== 'number' || typeof data.seed !== 'string'){
        log('⚠️ Save is corrupted.');
        return;
      }
      state.here = { q: data.q, r: data.r };
      state.hp = data.hp;
      state.turn = data.turn;
      state.seed = data.seed;
      placePlayer();
      selectHere();
      markAdjacents();
      updateHUD();
      log(`✔ Loaded: (${state.here.q}, ${state.here.r}), HP ${state.hp}, Turn ${state.turn}.`);
    }
    // === REGION:SAVE:END ===

    // === REGION:INPUT:START ===
    newBtn.addEventListener('click', newGame);
    saveBtn.addEventListener('click', saveGame);
    loadBtn.addEventListener('click', loadGame);
    clearLogBtn.addEventListener('click', clearLog);
    copyLogBtn.addEventListener('click', copyLog);
    // === REGION:INPUT:END ===

    // === REGION:SETTINGS:START ===
    // === REGION:SETTINGS:END ===

    // === REGION:FEATURES:START ===
    // === REGION:FEATURES:END ===

    init();
  })();
  </script>
</body>
</html>
